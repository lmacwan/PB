@inherits Umbraco.Web.Mvc.UmbracoViewPage<IPublishedContent>                                                                                                
@{
    var isHomePage = Model.Name.Equals("home", StringComparison.CurrentCultureIgnoreCase);
    IEnumerable<IPublishedContent> layout = Model.Ancestor(1).Siblings().Where(s => s.DocumentTypeAlias.Equals("layout", StringComparison.CurrentCultureIgnoreCase) && s.IsVisible());
    IEnumerable<IPublishedContent> headers = null;
    if (layout.Any())
    {
        headers = layout.First().Children(c => c.DocumentTypeAlias.Equals("header", StringComparison.CurrentCultureIgnoreCase) && c.IsVisible());
    }
}

@if (headers != null)
{
    IPublishedContent relatedTo = null;
    var navigation = headers.First().Children(c => c.DocumentTypeAlias.Equals("navigation", StringComparison.CurrentCultureIgnoreCase) && c.IsVisible()).FirstOrDefault();
    var showOnRight = "";
    if (navigation != null)
    {
        var hasChildren = false;
        var relatedToName = "";
        foreach (var childPage in navigation.Children.Where("Visible"))
        {
            hasChildren = childPage.Children.Where("Visible").Any();
            showOnRight = (childPage.Children.Count() > 0 &&
                                childPage.Index() >= navigation.Children(c => c.Children.Count() > 0).Count())
                                            ? "class=right"
                                            : "";
            if (isHomePage && !(childPage.GetPropertyValue<bool>("homepageVisible")))
            {
                continue;
            }
    <li @showOnRight>
        @if (hasChildren)
        {
            <i></i>
        }
        @if (childPage.GetPropertyValue<bool>("underConstruction"))
        {
            <a href="/underconstruction" controller="">@childPage.Name</a>
        }
        else if (childPage.HasValue("relatedTo"))
        {
            relatedTo = Umbraco.TypedContent(childPage.GetPropertyValue<int>("relatedTo"));
            relatedToName = relatedTo.Url.Contains("home") ? "/" : "/"+relatedTo.Url.Split('/').Reverse().Skip(1).First();
            <a href="@relatedToName" controller="@childPage.Name">@childPage.Name</a>
            
        }
        else
        {
            <a href="#" controller="@childPage.Name">@childPage.Name</a>
        }
        @if (childPage.Children.Count() > 0)
        {
            @childPages(childPage.Children)
        }
    </li>
        }
    }
}

@helper childPages(dynamic pages)
{
    var relatedToName = string.Empty;
    IPublishedContent relatedTo = null;
    <ul>
        @foreach (IPublishedContent page in pages)
        {
            <li>
                @if (page.GetPropertyValue<bool>("underConstruction"))
                {
                    <a href="#" controller="/underconstruction">@page.Name</a>
                }
                else if (page.HasValue("relatedTo"))
                {
                    relatedTo = Umbraco.TypedContent(page.GetPropertyValue<int>("relatedTo"));
                    relatedToName = relatedTo.Url.Substring((relatedTo.Url.IndexOf(relatedTo.Parent.Url) + relatedTo.Parent.Url.Length) - 1);
                    <a href="@relatedToName" controller="@page.Name">@page.Name</a>
                    
                }
                else
                {
                    <a href="#" controller="@page.Name">@page.Name</a>
                }
                @if (page.Children.Count() > 0)
                {
                    @childPages(page.Children)
                }
            </li>
        }
    </ul>
}